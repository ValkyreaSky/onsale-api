<div align="center">
  <a href="https://github.com/appalaszynski/selli-api">
    <img src="https://user-images.githubusercontent.com/35331661/44617885-ddbe3f80-a86b-11e8-818b-834c81eb0a70.png" height="125px">
  </a>
  <h1>Selli API</h1>
  <p>
    <em>RESTful API Built with Node.js</em>
  </p>
  <p>
    <a href="https://github.com/appalaszynski/selli-api/releases">
      <img src="https://img.shields.io/github/release/appalaszynski/selli-api.svg" alt="Release" />
    </a>
    <a href="https://github.com/appalaszynski/selli-api/blob/master/LICENSE">
      <img src="https://img.shields.io/github/license/appalaszynski/selli-api.svg" alt="License" />
    </a>
    <a href="https://travis-ci.org/appalaszynski/selli-api">
      <img src="https://travis-ci.org/appalaszynski/selli-api.svg?branch=master" alt="Build Status" />
    </a>
    <a href="https://coveralls.io/github/appalaszynski/selli-api">
      <img src="https://coveralls.io/repos/github/appalaszynski/selli-api/badge.svg?branch=master" alt="Coverage Status" />
    </a>
  </p>
  <br>
</div>

**Selli** is an application for free worldwide classifieds ads where you can buy and sell items, cars, properties, and find or offer jobs in your area. **Selli** is a kind of summary of my knowledge - basically, I want to include there everything that I've learned about creating a web application (including Git workflow).

This repository contains **Selli** RESTful API built with [Node.js](https://nodejs.org/) using packages such as [Express](https://expressjs.com/), [Mongoose](https://mongoosejs.com/), [Passport](http://www.passportjs.org/), [Multer](https://github.com/expressjs/multer) and [SuperTest](https://github.com/visionmedia/supertest). Application is hosted on [Heroku](https://www.heroku.com/) and MongoDB is hosted on [mLab](https://mlab.com/). As image upload service I chose [Cloudinary](https://cloudinary.com/). Server logs are generated by [winston](https://github.com/winstonjs/winston) and [morgan](https://github.com/expressjs/morgan).

**Selli** API client built with [React](https://reactjs.org/) is available [here](https://github.com/appalaszynski/selli-client).

---

## Table of Contents

- [Installation](#installation)
- [Usage](#usage)
- [Authorization](#authorization)
- [Categories](#categories)
- [Endpoints](#endpoints)
  - [Authorization](#authorization-1)
  - [Accounts](#accounts)
  - [Ads](#ads)
  - [Favourites](#favourites)
- [Contributing](#contributing)
- [License](#license)

---

## Installation

Clone the repo and install dependencies.

```bash
$ git clone https://github.com/appalaszynski/selli-api.git
$ cd selli-api
$ npm install
```

Application uses mLab as MongoDB hosting, Cloudinary as image upload service and Passport with JWT strategy as authentication middleware for Node.js. To configure this three things, you need to create `keys-dev.js` file in `/config` directory, exporting `mongodbUri`, `secretOrKey`, `cloudinaryCloudName`, `cloudinaryApiKey` and `cloudinaryApiSecret`.

```javascript
module.exports = {
  mongodbUri: 'mongodb://user:password@ds123456.mlab.com:12345/database',
  secretOrKey: 'verySecret',
  cloudinaryCloudName: 'cloudName',
  cloudinaryApiKey: '1234567890',
  cloudinaryApiSecret: 'alsoVerySecret',
};
```

In production they need to be available as `MONGO_URI`, `SECRET_OR_KEY`, `CLOUDINARY_CLOUD_NAME`, `CLOUDINARY_API_KEY` and `CLOUDINARY_API_SECRET` environment variables (e.g. `process.env.MONGO_URI`).

For testing purposes you need to create `keys-test.js` file in `/config` directory, exporting the same variables (`mongodbUri`, `secretOrKey`, etc.). MongoDB database declared there will be used in tests and should not be the same as the database used in production.

---

## Usage

### Developing

```bash
npm run dev
```

This command runs server using [nodemon](http://nodemon.io/) - tool that automatically restarts application when file changes are detected.

### Running Tests

```bash
npm test
```

This command sets value of `process.env.NODE_ENV` to `test` and runs Jest with two flags - `forceExit` and `runInBand`. First one force Jest to exit after all tests have completed running - without that `DNSCHANNEL` process keeps Jest from exiting. Second one runs all tests serially to avoid sharing the same database state between test suites.

### Deploying on Heroku

First, you have to install [Heroku CLI](https://devcenter.heroku.com/articles/heroku-cli).

```bash
$ heroku login # Login to your Heroku account
$ cd selli-client
$ git init # Initialize a Git repository (ignore if already exists)
$ heroku git:remote -a your-heroku-app-name # Add remote Git repository
$ git push heroku master
```

---

## Authorization

The API uses [JSON Web Token](https://jwt.io) authorization. For private endpoints you have to include JWT in the Authorization header using the Bearer schema. The content of the header should look like the following:

```
Authorization: Bearer <token>
```

To get the token use [Get the JWT](#get-the-jwt) endpoint. Every token expires in one hour.

## Categories

Some endpoints may also require a category identifier. Here is the list of available categories:

| ID   |      Description  | 
|:----------|:-------------|
| 1 | Jobs |
| 2 | Services |
| 3 | Pets |
| 4 | Motors |
| 5 | Electronics |
| 6 | Property |
| 7 | Sport & Hobby |
| 8 | Fashion |

## Endpoints

The API can be accessed from `https://selli-api.herokuapp.com`. Almost all data is sent and received as **JSON**.

```
$ curl -i https://selli-api.herokuapp.com/ads/last
HTTP/1.1 200 OK
Server: Cowboy
Connection: keep-alive
X-Powered-By: Express
Access-Control-Allow-Origin: *
Content-Type: application/json; charset=utf-8
Content-Length: 339
Etag: W/"153-BlPMGt7jYr08ESI4e1hli8FlbE0"
Date: Sat, 08 Sep 2018 12:43:56 GMT
Via: 1.1 vegur
```

The exception are endpoints where you can upload an account image or an ad image. In this case you need to send data with a Content-Type of `multipart/form-data`. Available image formats are `jpg`, `jpeg` and `png`. Maximum image file size is **500 KB**. Images are optional - if you don't want send any, encode data as JSON with a Content-Type of `application/json`.

### Authorization

#### Get the JWT

- URL: **/users/login**
- Method: **POST**
- Access: **Public**
- Required Data:
  - **email**: _**`(String)`**_,
  - **password**: _**`(String)`**_,
- Success Response: **JWT in the Bearer scheme**

### Accounts

#### Create a New Account

- URL: **/users/register**
- Method: **POST**
- Access: **public**
- Required Data:
  - **email**: _**`(String)`**_,
  - **password**: _**`(String)`**_,
  - **passwordConfirmation**: _**`(String)`**_,
  - **firstName**: _**`(String)`**_,
  - **lastName**: _**`(String)`**_,
- Optional Data:
  - **phone**: _**`(String)`**_,
- Success Response: **created account data**

#### Update Your Account

- URL: **/users**
- Method: **PATCH**
- Access: **Private**
- Optional Data:
  - **firstName**: _**`(String)`**_,
  - **lastName**: _**`(String)`**_,
  - **phone**: _**`(String)`**_,
  - **image**: _**`(File)`**_,
- Success Response: **your account data**

#### Remove Your Account

- URL: **/users**
- Method: **DELETE**
- Access: **Private**
- Success Response: **removed account data**

### Ads

#### Create an Ad

- URL: **/ads**
- Method: **POST**
- Access: **Private**
- Required Data:
  - **title**: _**`(String)`**_,
  - **description**: _**`(String)`**_,
  - **category**: _**`(Number)`**_,
  - **price**: _**`(Number)`**_,
  - **location**: _**`(String)`**_,
  - **isUsed**: _**`(Boolean)`**_,
- Optional Data:
  - **phone**: _**`(String)`**_,
  - **image**: _**`(File)`**_,
- Success Response: **created ad data**

#### Remove Your Ad

- URL: **/ads/:id**
- Method: **DELETE**
- Access: **Private**
- Required URL Params: 
  - **id**: _**`(Alphanumeric)`**_,
- Success Response: **removed ad data**

#### Get an Ad

- URL: **/ads/:id**
- Method: **GET**
- Access: **Public**
- Required URL Params: 
  - **id**: _**`(Alphanumeric)`**_,
- Success Response: **ad data**

#### Get Category Ads

- URL: **/ads/category/:id**
- Method: **GET**
- Access: **Public**
- Required URL Params: 
  - **id**: _**`(Number)`**_,
- Success Response: **array of category ads**

#### Get User's Ads

- URL: **/ads/user/:id**
- Method: **GET**
- Access: **Public**
- Required URL Params: 
  - **id**: _**`(Alphanumeric)`**_,
- Success Response: **array of user's ads**

#### Get Last Ads

- URL: **/ads/last**
- Method: **GET**
- Access: **Public**
- Success Response: **array of last 25 ads**

#### Search Ads

- URL: **/ads?title=:title&location=:location&category=:category&minPrice=:minPrice&maxPrice=:maxPrice**
- Method: **GET**
- Access: **Public**
- Optional URL Params: 
  - **title**: _**`(String)`**_,
  - **location**: _**`(String)`**_,
  - **category**: _**`(Number)`**_,
  - **minPrice**: _**`(Number)`**_,
  - **maxPrice**: _**`(Number)`**_,
- Success Response: **array of found ads**

### Favourites

#### Get Your Favourites

- URL: **/favourites**
- Method: **GET**
- Access: **Private**
- Success Response: **array of your favourites**

#### Add an Ad to Your Favourites

- URL: **/favourites/:id**
- Method: **POST**
- Access: **Private**
- Required URL Params: 
  - **id**: _**`(Alphanumeric)`**_,
- Success Response: **array of your favourites**

#### Remove an Ad from Your Favourites

- URL: **/favourites/:id**
- Method: **DELETE**
- Access: **Private**
- Required URL Params: 
  - **id**: _**`(Alphanumeric)`**_,
- Success Response: **array of your favourites**

---

## Contributing

All contributions and suggestions are welcome! For suggested improvements, please create an [issue](https://github.com/appalaszynski/selli-api/issues). For direct contributions, please [fork](https://github.com/appalaszynski/selli-api/fork) the repository, create your feature branch, commit your changes, push commits to the branch and create a new [pull request](https://github.com/appalaszynski/selli-api/pulls).

---

## License

The code is open source and available under the [MIT License](https://github.com/appalaszynski/selli-api/blob/master/LICENSE).
